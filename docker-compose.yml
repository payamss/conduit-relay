version: '3.8'

# Conduit Relay + Dashboard
# Usage: docker compose up -d
#
# For HTTPS: Set DOMAIN in .env file
# The caddy service auto-enables when DOMAIN is set

services:
  relay:
    image: ghcr.io/ssmirr/conduit/conduit:latest
    container_name: conduit-relay
    restart: unless-stopped
    command:
      - start
      - -m
      - "${MAX_CLIENTS:-200}"
      - -b
      - "${BANDWIDTH:--1}"
      - --data-dir
      - /home/conduit/data
      - -v
    volumes:
      - relay-data:/home/conduit/data
    # Conduit uses random UDP ports for WebRTC, needs host networking
    network_mode: host

  dashboard:
    image: ghcr.io/paradixe/conduit-dashboard:latest
    container_name: conduit-dashboard
    restart: unless-stopped
    environment:
      - PORT=3000
      - DASHBOARD_PASSWORD=${DASHBOARD_PASSWORD}
      - SESSION_SECRET=${SESSION_SECRET}
      - JOIN_TOKEN=${JOIN_TOKEN}
      # SSH_KEY_PATH is set by entrypoint after copying keys
    volumes:
      - dashboard-data:/opt/conduit-dashboard/data
      # SSH keys mounted as root-readable, entrypoint copies to node user
      - ${SSH_KEY_PATH:-~/.ssh/id_ed25519}:/ssh/id_ed25519:ro
      - ${SSH_KEY_PATH:-~/.ssh/id_ed25519}.pub:/ssh/id_ed25519.pub:ro
    # Expose port 3000 for HTTP-only mode (when not using Caddy)
    ports:
      - "3000:3000"
    depends_on:
      - relay

  # Caddy reverse proxy for HTTPS (auto-enabled when DOMAIN is set)
  caddy:
    image: caddy:2-alpine
    container_name: conduit-caddy
    restart: unless-stopped
    profiles:
      - https
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - dashboard

volumes:
  relay-data:
    name: conduit-relay-data
  dashboard-data:
    name: conduit-dashboard-data
  caddy-data:
    name: conduit-caddy-data
  caddy-config:
    name: conduit-caddy-config
